name: Force Merge External Commit

on:
  workflow_dispatch:
    inputs:
      commit_id:
        description: "Commit ID dari repo sumber"
        required: true
      source_repo:
        description: "Repo sumber (HTTPS)"
        required: true
      target_repo:
        description: "Repo tujuan (format: owner/repo)"
        required: true
        default: "tes-rep/linux-6.12.y"
      target_branch:
        description: "Branch tujuan"
        required: true
        default: "main"
      target_pat:
        description: "Pilih PAT (tes-rep, Dirgha80, Houjie80)"
        type: choice
        required: true
        default: "tes-rep"
        options:
          - tes-rep
          - Dirgha80
          - Houjie80

jobs:
  force_merge:
    runs-on: ubuntu-latest

    steps:
      - name: Pilih PAT
        id: choose_target
        run: |
          case "${{ github.event.inputs.target_pat }}" in
            tes-rep)
              echo "PAT=${{ secrets.TARGET_REPO_TES }}" >> $GITHUB_ENV ;;
            Dirgha80)
              echo "PAT=${{ secrets.TARGET_REPO_DIRGHA80 }}" >> $GITHUB_ENV ;;
            Houjie80)
              echo "PAT=${{ secrets.TARGET_REPO_HOUJIE80 }}" >> $GITHUB_ENV ;;
            *)
              echo "::error ::Pilihan PAT tidak valid!"
              exit 1 ;;
          esac

      - name: Clone target repo
        env:
          PAT: ${{ env.PAT }}
        run: |
          git clone https://$PAT@github.com/${{ github.event.inputs.target_repo }} target
          cd target
          git checkout ${{ github.event.inputs.target_branch }}

      - name: Set Git identity
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Add source repo & fetch commit
        working-directory: target
        run: |
          git remote add source ${{ github.event.inputs.source_repo }}
          git fetch source

      - name: Force cherry-pick
        working-directory: target
        run: |
          git cherry-pick -X theirs ${{ github.event.inputs.commit_id }} || \
          (echo "Gagal total â†’ reset hard"; git reset --hard HEAD)

      - name: Push to target repo
        working-directory: target
        env:
          PAT: ${{ env.PAT }}
        run: |
          git push https://$PAT@github.com/${{ github.event.inputs.target_repo }} HEAD:${{ github.event.inputs.target_branch }}
