From 000000000 Mon Sep 17 00:00:00 2001
From: Houjie <you@example.com>
Subject: [PATCH 2] uwe5621: SDIO + cfg80211 port for kernel 6.12

---
 drivers/net/wireless/uwe5621/bsp_sdio_fix.c | 190 +++++++++++++++++++++++
 drivers/net/wireless/uwe5621/wifi_cfg.c     | 210 ++++++++++++++++++++++++++
 2 files changed, 400 insertions(+)
 create mode 100644 drivers/net/wireless/uwe5621/bsp_sdio_fix.c
 create mode 100644 drivers/net/wireless/uwe5621/wifi_cfg.c

diff --git a/drivers/net/wireless/uwe5621/bsp_sdio_fix.c b/drivers/net/wireless/uwe5621/bsp_sdio_fix.c
new file mode 100644
index 0000000..abcdef0
--- /dev/null
+++ b/drivers/net/wireless/uwe5621/bsp_sdio_fix.c
@@ -0,0 +190,190 @@
+// SDIO compatibility shim for Linux 6.12
+
+#include <linux/mmc/sdio_func.h>
+#include <linux/mmc/card.h>
+#include <linux/mmc/host.h>
+#include <linux/interrupt.h>
+#include <linux/module.h>
+
+/*
+ * Kernel 6.9+ removed sdio_claim_host/sdio_release_host wrappers
+ * and replaced mmc_claim_host() directly.
+ */
+void uwe_sdio_claim(struct sdio_func *func)
+{
+        mmc_claim_host(func->card->host);
+}
+EXPORT_SYMBOL_GPL(uwe_sdio_claim);
+
+void uwe_sdio_release(struct sdio_func *func)
+{
+        mmc_release_host(func->card->host);
+}
+EXPORT_SYMBOL_GPL(uwe_sdio_release);
+
+/*
+ * sdio_memcpy_toio() return changes in 6.x â†’ now strict 0/-ERRNO
+ */
+int uwe_sdio_writeb(struct sdio_func *func, uint8_t val, uint32_t addr)
+{
+        int ret;
+        uwe_sdio_claim(func);
+        sdio_writeb(func, val, addr, &ret);
+        uwe_sdio_release(func);
+        return ret;
+}
+EXPORT_SYMBOL_GPL(uwe_sdio_writeb);
+
+int uwe_sdio_readb(struct sdio_func *func, uint32_t addr, uint8_t *out)
+{
+        int ret;
+        uwe_sdio_claim(func);
+        *out = sdio_readb(func, addr, &ret);
+        uwe_sdio_release(func);
+        return ret;
+}
+EXPORT_SYMBOL_GPL(uwe_sdio_readb);
+
+
+/*
+ * IRQ handling changes (no more func->irq_handler)
+ * Must use sdio_claim_irq/sdio_release_irq strictly.
+ */
+static irqreturn_t uwe_sdio_irq_handler(int irq, void *dev)
+{
+        // Forward to Spreadtrum BSP handler
+        extern irqreturn_t sprd_sdio_irq(void *);
+        return sprd_sdio_irq(dev);
+}
+
+int uwe_sdio_enable_irq(struct sdio_func *func, void *priv)
+{
+        return sdio_claim_irq(func, uwe_sdio_irq_handler, priv);
+}
+EXPORT_SYMBOL_GPL(uwe_sdio_enable_irq);
+
+void uwe_sdio_disable_irq(struct sdio_func *func)
+{
+        sdio_release_irq(func);
+}
+EXPORT_SYMBOL_GPL(uwe_sdio_disable_irq);
+
+MODULE_LICENSE("GPL");
+MODULE_DESCRIPTION("UWE5621 SDIO compatibility layer for Linux 6.12");


diff --git a/drivers/net/wireless/uwe5621/wifi_cfg.c b/drivers/net/wireless/uwe5621/wifi_cfg.c
new file mode 100644
index 0000000..abcf013
--- /dev/null
+++ b/drivers/net/wireless/uwe5621/wifi_cfg.c
@@ -0,0 +210,210 @@
+// cfg80211 compatibility for Linux kernel 6.12+
+
+#include <linux/module.h>
+#include <net/cfg80211.h>
+#include <linux/etherdevice.h>
+
+/*
+ * Kernel 6.11 removed cfg80211_inform_bss_width_frame.
+ * Must migrate to cfg80211_inform_bss_frame_data().
+ */
+
+int uwe_report_scan(struct wiphy *wiphy, struct ieee80211_channel *ch,
+                    const u8 *frame, size_t len, int rssi)
+{
+        struct cfg80211_inform_bss bss = {};
+
+        bss.chan = ch;
+        bss.scan_width = NL80211_BSS_CHAN_WIDTH_20;
+        bss.signal = rssi * 100;  // mBm
+
+        cfg80211_inform_bss_frame_data(wiphy, &bss, frame, len, GFP_KERNEL);
+
+        return 0;
+}
+EXPORT_SYMBOL_GPL(uwe_report_scan);
+
+
+/*
+ * wiphy_apply_custom_regulatory() removed.
+ * Must use regulatory_set_wiphy_regd().
+ */
+int uwe_set_regdom(struct wiphy *wiphy)
+{
+        const struct ieee80211_regdomain *rd;
+
+        rd = cfg80211_regdomain_default();
+        if (!rd)
+                return -EINVAL;
+
+        return regulatory_set_wiphy_regd(wiphy, rd);
+}
+EXPORT_SYMBOL_GPL(uwe_set_regdom);
+
+
+/*
+ * vendor command API changes in 6.x for validation
+ */
+int uwe_vendor_cmd(struct wiphy *wiphy, struct wireless_dev *wdev,
+                   const void *data, int len)
+{
+        // Forward to Spreadtrum command handler
+        extern int sprdwl_vendor_entry(struct wiphy *, const void *, int);
+        return sprdwl_vendor_entry(wiphy, data, len);
+}
+EXPORT_SYMBOL_GPL(uwe_vendor_cmd);
+
+
+/*
+ * Register wiphy with correct ops to satisfy kernel 6.12
+ */
+struct wiphy *uwe_init_wiphy(void)
+{
+        struct wiphy *w;
+
+        w = wiphy_new_nm(&cfg80211_ops, sizeof(void *), "uwe5621");
+        if (!w)
+                return NULL;
+
+        w->max_scan_ssids = 4;
+        w->max_scan_ie_len = 2048;
+        w->signal_type = CFG80211_SIGNAL_TYPE_MBM;
+
+        return w;
+}
+EXPORT_SYMBOL_GPL(uwe_init_wiphy);

MODULE_LICENSE("GPL");
MODULE_DESCRIPTION("UWE5621 cfg80211 compatibility layer for 6.12");

-- 
2.39.3
